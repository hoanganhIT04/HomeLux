<?php

namespace App\Http\Controllers;

use Illuminate\Http\Request;
use Illuminate\Support\Facades\Http;
use Illuminate\Support\Facades\Log;


class PaymentController extends Controller
{
    public function createPayment(Request $request)
    {
        $amount = $request->amount ?? 10000;
        $orderInfo = $request->orderInfo ?? "Test Thanh Toán MoMo";
        $orderId = time();
        $requestId = time();

        $endpoint = env('MOMO_ENDPOINT');

        $rawHash = "partnerCode=" . env('MOMO_PARTNER_CODE') .
            "&accessKey=" . env('MOMO_ACCESS_KEY') .
            "&requestId=" . $requestId .
            "&amount=" . $amount .
            "&orderId=" . $orderId .
            "&orderInfo=" . $orderInfo .
            "&returnUrl=" . env('MOMO_RETURN_URL') .
            "&notifyUrl=" . env('MOMO_NOTIFY_URL') .
            "&extraData=";

        $signature = hash_hmac("sha256", $rawHash, env('MOMO_SECRET_KEY'));

        $payload = [
            "partnerCode" => env('MOMO_PARTNER_CODE'),
            "accessKey" => env('MOMO_ACCESS_KEY'),
            "requestId" => $requestId,
            "amount" => $amount,
            "orderId" => $orderId,
            "orderInfo" => $orderInfo,
            "returnUrl" => env('MOMO_RETURN_URL'),
            "notifyUrl" => env('MOMO_NOTIFY_URL'),
            "extraData" => "",
            "requestType" => "captureMoMoWallet",
            "signature" => $signature
        ];

        $response = Http::post($endpoint, $payload);

        return response()->json([
            "momo" => $response->json(),
            "payUrl" => $response->json()["payUrl"] ?? null
        ]);
    }

    public function returnPayment(Request $request)
    {
        return response()->json([
            "return_data" => $request->all()
        ]);
    }

    public function notifyPayment(Request $request)
    {
        // MoMo notify server -> đây là IPN, luôn phải trả 200 OK
        Log::info('MOMO IPN', ['payload' => $request->all()]);

        return response()->json(['result' => 'OK']);
    }
}

///////
 // public function momoPayment()
    // {
    //     $endpoint = "https://test-payment.momo.vn/v2/gateway/api/create";

    //     $partnerCode = env('MOMO_PARTNER_CODE');
    //     $accessKey   = env('MOMO_ACCESS_KEY');
    //     $secretKey   = env('MOMO_SECRET_KEY');

    //     $orderId     = time();   // Mã đơn hàng
    //     $orderInfo   = "Thanh toán đơn hàng #$orderId";
    //     $amount      = "10000"; // Test 100.000 VND
    //     $redirectUrl = env('MOMO_REDIRECT_URL');
    //     $ipnUrl      = env('MOMO_IPN_URL');
    //     $requestId   = time();

    //     $requestType = "captureWallet";

    //     $rawHash = "accessKey=$accessKey&amount=$amount&extraData=&ipnUrl=$ipnUrl&orderId=$orderId&orderInfo=$orderInfo&partnerCode=$partnerCode&redirectUrl=$redirectUrl&requestId=$requestId&requestType=$requestType";

    //     $signature = hash_hmac("sha256", $rawHash, $secretKey);

    //     $data = [
    //         'partnerCode' => $partnerCode,
    //         'partnerName' => "MoMo Payment",
    //         'storeId'     => "MomoTestStore",
    //         'requestId'   => $requestId,
    //         'amount'      => $amount,
    //         'orderId'     => $orderId,
    //         'orderInfo'   => $orderInfo,
    //         'redirectUrl' => $redirectUrl,
    //         'ipnUrl'      => $ipnUrl,
    //         'lang'        => 'vi',
    //         'extraData'   => "",
    //         'requestType' => $requestType,
    //         'signature'   => $signature
    //     ];

    //     $result = $this->execPostRequest($endpoint, json_encode($data));

    //     $jsonResult = json_decode($result, true);

    //     return redirect($jsonResult['payUrl']);
    // }


    

    // redirect to link momo payment
    // public function momoPayment()
    // {
    //     $endpoint = "https://test-payment.momo.vn/v2/gateway/api/create";

    //     $partnerCode = env('MOMO_PARTNER_CODE');
    //     $accessKey   = env('MOMO_ACCESS_KEY');
    //     $secretKey   = env('MOMO_SECRET_KEY');

    //     $orderId     = time();   // Mã đơn hàng
    //     $orderInfo   = "Thanh toán đơn hàng #$orderId";
    //     $amount      = "10000"; // Test 100.000 VND
    //     $redirectUrl = env('MOMO_REDIRECT_URL');
    //     $ipnUrl      = env('MOMO_IPN_URL');
    //     $requestId   = time();

    //     $requestType = "captureWallet";

    //     $rawHash = "accessKey=$accessKey&amount=$amount&extraData=&ipnUrl=$ipnUrl&orderId=$orderId&orderInfo=$orderInfo&partnerCode=$partnerCode&redirectUrl=$redirectUrl&requestId=$requestId&requestType=$requestType";

    //     $signature = hash_hmac("sha256", $rawHash, $secretKey);

    //     $data = [
    //         'partnerCode' => $partnerCode,
    //         'partnerName' => "MoMo Payment",
    //         'storeId'     => "MomoTestStore",
    //         'requestId'   => $requestId,
    //         'amount'      => $amount,
    //         'orderId'     => $orderId,
    //         'orderInfo'   => $orderInfo,
    //         'redirectUrl' => $redirectUrl,
    //         'ipnUrl'      => $ipnUrl,
    //         'lang'        => 'vi',
    //         'extraData'   => "",
    //         'requestType' => $requestType,
    //         'signature'   => $signature
    //     ];

    //     $result = $this->execPostRequest($endpoint, json_encode($data));

    //     $jsonResult = json_decode($result, true);

    //     return redirect($jsonResult['payUrl']);
    // }